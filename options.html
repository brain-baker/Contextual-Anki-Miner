<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Settings — Contextual Anki Dictionary</title>
<style>
:root{--bg:#1a1a1a;--card:#252525;--border:#383838;--fg:#e8e4e0;--fg2:#9a9590;--fg3:#6a6560;--accent:#c9a87c;--inp:#1e1e1e;--ok:#5a9e5a;--err:#c45454;}
*{box-sizing:border-box;margin:0;padding:0;}

/* Bulletproof layout - no flex on body to prevent accidental horizontal stacking */
body{font-family:"Segoe UI",system-ui,sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;transition:background .3s,color .3s;overflow-y:auto;padding-bottom:60px;}
.wrap{width:100%;max-width:560px;margin:40px auto;padding:0 16px;}

h1{font-size:20px;font-weight:700;margin-bottom:2px;}
.sub{font-size:12px;color:var(--fg3);margin-bottom:24px;}
.crd{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:14px;}
.crd h2{font-size:11px;color:var(--fg3);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;}
.fld{margin-bottom:12px;}.fld:last-child{margin-bottom:0;}
label{display:block;font-size:12px;color:var(--fg2);margin-bottom:4px;font-weight:600;}
input[type="text"],input[type="password"],input[type="number"],select{width:100%;padding:8px 10px;background:var(--inp);border:1px solid var(--border);border-radius:6px;color:var(--fg);font-size:13px;outline:none;}
input[type="color"]{width:100%;height:32px;border:1px solid var(--border);border-radius:6px;background:var(--inp);cursor:pointer;padding:2px;}
input:focus,select:focus{border-color:var(--accent);}
.hint{font-size:10px;color:var(--fg3);margin-top:2px;}.hint a{color:var(--accent);}
.row{display:flex;gap:10px;}.row .fld{flex:1;}
.tr{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);}
.tr:last-child{border-bottom:none;}
.tl{font-size:12px;}.tl small{display:block;font-size:10px;color:var(--fg3);margin-top:1px;}
.sw{position:relative;width:36px;height:20px;flex-shrink:0;}.sw input{opacity:0;width:0;height:0;}
.sw .sl{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.2s;}
.sw .sl:before{content:"";position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s;}
.sw input:checked+.sl{background:var(--accent);}.sw input:checked+.sl:before{transform:translateX(16px);}
.kbox{display:flex;gap:8px;}.kd{flex:1;padding:8px 10px;background:var(--inp);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--fg);min-height:36px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;cursor:pointer;}
.kd.rec{border-color:var(--accent);}.kd .k{display:inline-block;padding:2px 7px;background:var(--card);border:1px solid var(--border);border-radius:3px;font-size:11px;font-weight:600;}.kd .p{color:var(--fg3);font-size:11px;}
.sb{padding:6px 10px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--fg2);font-size:11px;cursor:pointer;white-space:nowrap;}.sb:hover{border-color:var(--fg3);}
.ptabs{display:flex;margin-bottom:12px;border-radius:6px;overflow:hidden;border:1px solid var(--border);}
.ptab{flex:1;padding:8px 4px;text-align:center;font-size:11px;font-weight:600;cursor:pointer;background:var(--inp);color:var(--fg3);border:none;}.ptab:not(:last-child){border-right:1px solid var(--border);}
.ptab.act{background:var(--accent);color:var(--bg);}.ptab:hover:not(.act){background:var(--card);}
.psec{display:none;}.psec.act{display:block;}
.tp{position:relative;}.tp input{padding-right:36px;}.tp button{position:absolute;right:5px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--fg3);cursor:pointer;font-size:11px;padding:2px;}
.drow{display:flex;gap:6px;}.drow select{flex:1;}
.ast{display:flex;align-items:center;gap:6px;padding:7px 10px;border-radius:6px;font-size:11px;margin-bottom:12px;}
.ast.ok{background:rgba(90,158,90,.06);border:1px solid rgba(90,158,90,.15);color:var(--ok);}
.ast.er{background:rgba(196,84,84,.06);border:1px solid rgba(196,84,84,.15);color:var(--err);}
.ast .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}.ast.ok .dot{background:var(--ok);}.ast.er .dot{background:var(--err);}
.pills{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
.pill{padding:7px 12px;border-radius:7px;cursor:pointer;border:2px solid transparent;font-size:11px;font-weight:600;transition:all .15s;position:relative;}.pill:hover{transform:scale(1.03);}.pill.sel{border-width:2px;}
.pill .del{position:absolute;top:-4px;right:-4px;width:14px;height:14px;border-radius:50%;background:#c45454;color:#fff;font-size:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;line-height:1;}
.radio-row{display:flex;gap:16px;margin-bottom:12px;}
.radio-row label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;font-weight:500;color:var(--fg);}
.radio-row input[type="radio"]{accent-color:var(--accent);width:14px;height:14px;}
.fmap-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border);}
.fmap-row:last-child{border-bottom:none;}
.fmap-label{font-size:12px;width:110px;flex-shrink:0;color:var(--fg);}.fmap-label small{display:block;font-size:10px;color:var(--fg3);}
.fmap-row select{flex:1;}
#customCreator{display:none;margin-top:10px;padding:12px;background:var(--inp);border:1px solid var(--border);border-radius:8px;}
.save{width:100%;padding:10px;border:none;border-radius:8px;background:var(--accent);color:var(--bg);font-size:13px;font-weight:700;cursor:pointer;}.save:hover{opacity:.9;}
.status{text-align:center;margin-top:10px;font-size:12px;min-height:18px;}.status.success{color:var(--ok);}.status.error{color:var(--err);}
.speed{font-size:9px;color:var(--fg3);font-weight:400;margin-left:4px;}
</style>
</head>
<body>
<div class="wrap">
<h1>Contextual Anki Dictionary</h1>
<p class="sub">Settings</p>

<!-- THEME -->
<div class="crd"><h2>Popup Theme</h2>
<div class="pills" id="pills"></div>
<button class="sb" id="showCreator">+ Create custom theme</button>
<div id="customCreator">
  <div class="fld"><label>Theme name (unique)</label><input type="text" id="ctName" placeholder="My Theme"></div>
  <div class="row">
    <div class="fld"><label>Page bg</label><input type="color" id="ctPageBg" value="#1a1a1a"></div>
    <div class="fld"><label>Card bg</label><input type="color" id="ctCardBg" value="#252525"></div>
    <div class="fld"><label>Border</label><input type="color" id="ctBorder" value="#383838"></div>
  </div>
  <div class="row">
    <div class="fld"><label>Text</label><input type="color" id="ctFg" value="#e8e4e0"></div>
    <div class="fld"><label>Text dim</label><input type="color" id="ctFgDim" value="#9a9590"></div>
    <div class="fld"><label>Accent</label><input type="color" id="ctAccent" value="#c9a87c"></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:10px;"><button class="sb" id="ctSave">Save theme</button><button class="sb" id="ctCancel">Cancel</button></div>
  <div class="hint" id="ctError" style="color:var(--err);margin-top:6px;"></div>
</div>
</div>

<!-- LANGUAGE -->
<div class="crd"><h2>Language</h2>
<div class="row">
  <div class="fld"><label>Word is in</label><select id="sourceLang"><option value="auto">Auto-detect</option><option>English</option><option>Spanish</option><option>French</option><option>German</option><option>Italian</option><option>Portuguese</option><option>Russian</option><option>Japanese</option><option>Korean</option><option>Chinese</option><option>Arabic</option><option>Hindi</option><option>Turkish</option><option>Dutch</option><option>Swedish</option><option>Polish</option><option>Thai</option><option>Vietnamese</option><option>Indonesian</option><option>Czech</option><option>Greek</option><option>Hebrew</option><option>Romanian</option><option>Ukrainian</option><option>Finnish</option><option>Danish</option><option>Norwegian</option><option>Hungarian</option><option>Persian</option><option>Urdu</option></select></div>
  <div class="fld"><label>Define in</label><select id="nativeLang"><option>English</option><option>Spanish</option><option>French</option><option>German</option><option>Italian</option><option>Portuguese</option><option>Russian</option><option>Japanese</option><option>Korean</option><option>Chinese</option><option>Arabic</option><option>Hindi</option><option>Turkish</option><option>Dutch</option><option>Swedish</option><option>Polish</option><option>Thai</option><option>Vietnamese</option><option>Indonesian</option><option>Czech</option><option>Greek</option><option>Hebrew</option><option>Romanian</option><option>Ukrainian</option><option>Finnish</option><option>Danish</option><option>Norwegian</option><option>Hungarian</option><option>Persian</option><option>Urdu</option></select></div>
</div>
<div class="tr" style="margin-top:10px; border-bottom: none;"><div class="tl">Translate Examples<small>Show native translation below examples</small></div><label class="sw"><input type="checkbox" id="translateExamples" checked><span class="sl"></span></label></div>
<div class="fld" style="margin-top:10px;">
  <label for="defLength">Definition detail</label>
  <select id="defLength">
    <option value="brief" selected>Brief — one concise sentence</option>
    <option value="detailed">Detailed — thorough with nuances</option>
  </select>
</div>
</div>

<!-- KEYBIND -->
<div class="crd"><h2>Trigger</h2>
<div class="fld"><label>Keyboard shortcut</label><div class="kbox"><div class="kd" id="kbD" tabindex="0"><span class="k">Shift</span></div><button class="sb" id="kbR">Reset</button></div><div class="hint">Click box, press your combo. Hover over a word and press it.</div></div>
</div>

<!-- AI -->
<div class="crd"><h2>AI Provider</h2>
<div class="ptabs">
  <button class="ptab" data-p="gemini">Gemini<span class="speed">variable quota</span></button>
  <button class="ptab act" data-p="groq">Groq<span class="speed">fastest</span></button>
  <button class="ptab" data-p="openrouter">OpenRouter<span class="speed">many free</span></button>
</div>
<div class="psec" id="s-gemini">
  <div class="fld"><label>API Key</label><div class="tp"><input type="password" id="geminiApiKey" placeholder="Key"><button class="tpb" data-t="geminiApiKey">show</button></div><div class="hint"><a href="https://aistudio.google.com/app/apikey" target="_blank">Get key</a></div></div>
  <div class="fld"><label>Model</label><select id="geminiModel"><option value="gemini-2.0-flash">gemini-2.0-flash — fast, reliable</option><option value="gemini-2.5-flash">gemini-2.5-flash — moderate, smarter</option><option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite — fastest, basic</option><option value="gemini-1.5-flash">gemini-1.5-flash — fast, stable</option></select></div>
</div>
<div class="psec act" id="s-groq">
  <div class="fld"><label>API Key</label><div class="tp"><input type="password" id="groqApiKey" placeholder="Key"><button class="tpb" data-t="groqApiKey">show</button></div><div class="hint"><a href="https://console.groq.com/keys" target="_blank">Get key</a> — 30 req/min free</div></div>
  <div class="fld"><label>Model</label><select id="groqModel"><option value="llama-3.3-70b-versatile">Llama 3.3 70B — fast, accurate</option><option value="llama-3.1-8b-instant">Llama 3.1 8B — fastest, basic</option><option value="gemma2-9b-it">Gemma 2 9B — fast, decent</option><option value="mixtral-8x7b-32768">Mixtral 8x7B — fast, versatile</option></select></div>
</div>
<div class="psec" id="s-openrouter">
  <div class="fld"><label>API Key</label><div class="tp"><input type="password" id="openrouterApiKey" placeholder="Key"><button class="tpb" data-t="openrouterApiKey">show</button></div><div class="hint"><a href="https://openrouter.ai/keys" target="_blank">Get key</a></div></div>
  <div class="fld"><label>Model</label><select id="openrouterModel"><option value="meta-llama/llama-4-maverick:free">Llama 4 Maverick — free, accurate</option><option value="meta-llama/llama-4-scout:free">Llama 4 Scout — free, fast</option><option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek V3 — free, very smart</option><option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash — free, fast</option><option value="qwen/qwen3-235b-a22b:free">Qwen 3 235B — free, slow, smartest</option></select></div>
</div>
</div>

<!-- ANKI -->
<div class="crd"><h2>Anki</h2>
<div class="ast er" id="ankiSt"><div class="dot"></div><span id="ankiStT">Not connected</span></div>
<div class="fld"><label>Deck</label><div class="drow"><select id="ankiDeck"><option value="">Click Refresh</option></select><button class="sb" id="refDk">Refresh</button></div></div>
<div class="fld"><label>Tags (comma-separated)</label><input type="text" id="ankiTags" placeholder="vocabulary"></div>

<h2 style="margin-top:16px;">Note Type</h2>
<div class="radio-row">
  <label><input type="radio" name="ntMode" value="extension" checked> Extension styled cards</label>
  <label><input type="radio" name="ntMode" value="custom"> Your own note type</label>
</div>

<div id="extSection">
  <div class="hint" style="margin-bottom:8px;">Cards use the extension's floating bubble design. Choose a card theme:</div>
  <div class="pills" id="cardPills"></div>
</div>

<div id="customSection" style="display:none;">
  <div class="fld"><label>Note Type</label><div class="drow"><select id="customNT"><option value="">Click Refresh</option></select><button class="sb" id="refNT">Refresh</button></div></div>
  <div id="fieldMapArea" style="margin-top:10px;display:none;">
    <label style="margin-bottom:8px;">Map your data to fields:</label>
    <div id="fieldMap"></div>
  </div>
</div>
</div>

<!-- CARD FIELDS -->
<div class="crd"><h2>Card Fields</h2>
<div class="tr"><div class="tl">Pronunciation<small>IPA</small></div><label class="sw"><input type="checkbox" id="fieldPronunciation" checked><span class="sl"></span></label></div>
<div class="tr"><div class="tl">Part of speech<small>Noun, verb...</small></div><label class="sw"><input type="checkbox" id="fieldPartOfSpeech" checked><span class="sl"></span></label></div>
<div class="tr"><div class="tl">Examples<small>AI examples</small></div><label class="sw"><input type="checkbox" id="fieldExamples" checked><span class="sl"></span></label></div>
<div class="tr"><div class="tl">Context<small>Source sentence</small></div><label class="sw"><input type="checkbox" id="fieldContext" checked><span class="sl"></span></label></div>
<div class="tr"><div class="tl">Audio<small>Downloaded to Anki</small></div><label class="sw"><input type="checkbox" id="fieldAudio" checked><span class="sl"></span></label></div>
<div class="tr"><div class="tl">Reverse card<small>Definition → Word</small></div><label class="sw"><input type="checkbox" id="includeReverse" checked><span class="sl"></span></label></div>
<div class="fld" style="margin-top:10px;"><label>Examples count (1-5)</label><input type="number" id="numExamples" min="1" max="5" value="2" style="width:80px;"></div>
</div>

<button class="save" id="saveBtn">Save Settings</button>
<div class="status" id="status"></div>
</div>
<script src="options.js"></script>
</body>
</html>